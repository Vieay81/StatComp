---
title: "A-20020-2020-11-17"
output: html_document
---
## Question
Exercises 9.4 and 11.4 (page 277 and 353, Statistical Computating with R).  

## Answer
#### Exercise 9.4 
```{r}
rw_Metropolis <- function(sigma, x0, N)
{
  x <- numeric(N)
  x[1] <- x0
  u <- runif(N)
  k <- 0
  for (i in 2:N)
  {
    y <- rnorm(1, x[i-1], sigma)
    if (u[i] <= exp(-abs(y))/exp(-abs(x[i-1])))
      x[i] <- y
    else
    {
      x[i] <- x[i-1]
      k <- k + 1
    }
  }
  list(x = x, k = k)
}

set.seed(324)
N <- 2000
sigma <- c(.05, .5, 2, 4)
x0 <- 0
rw1 <- rw_Metropolis(sigma[1], x0, N)
rw2 <- rw_Metropolis(sigma[2], x0, N)
rw3 <- rw_Metropolis(sigma[3], x0, N)
rw4 <- rw_Metropolis(sigma[4], x0, N)
par(mfrow = c(2,2))
plot(1:N, rw1$x, type = "l", xlab = expression(sigma==0.05))
plot(1:N, rw2$x, type = "l", xlab = expression(sigma==0.5))
plot(1:N, rw3$x, type = "l", xlab = expression(sigma==02))
plot(1:N, rw4$x, type = "l", xlab = expression(sigma==4))
accept <- 1 - c(rw1$k, rw2$k, rw3$k, rw4$k) / N
print(accept)
```
From the plots, we can see that the ratios $r(X_t,Y)$ with $\sigma=0.05$ tend to be large and almost every candidate point is accepted. The increments are small and the chain is almost like a true random walk. Chain 1 has not converged to the target in 2000 interations. The Chain 2 generated with $\sigma=0.5$ is converging slowly. The Chain 3 and Chain 4 are mixing well and converging to the targest distribution after a short burn-in period.

In addtion, the acceptance rates are `r accept` respectively, 

## Exercise 9.4(Cont.)
```{r}
GR <- function(psi)
{
  psi <- as.matrix(psi)
  n <- ncol(psi)
  k <- nrow(psi)
  m <- rowMeans(psi)
  B <- n * var(m)
  w <- apply(psi, 1, "var")
  W <- mean(w)
  v_ <- W*(n-1)/n + B/n
  r_ <- v_ / W
  r_
}

set.seed(324)
N <- 2000
burn <- 200
x0 <- c(-10, -5, 5, 10)
X <- matrix(nrow = 4, ncol = N)
for (i in 1:4)
{
  X[i,] <- rw_Metropolis(sigma[2], x0[i], N)$x
}
psi <- t(apply(X, 1, cumsum))
for (i in 1:nrow(psi))
  psi[i,] <- psi[i,] / (1:ncol(psi))
R_ <- GR(psi)
par(mfrow = c(2,2))
for (i in 1:4)
  plot(psi[i, (burn+1):N], type = "l", xlab = paste("x0 =", x0[i]), ylab = bquote(psi))
par(mfrow = c(1,1))
r_ <- numeric(N)
for (i in (burn+1):N)
  r_[i] <- GR(psi[,1:i])
plot(r_[(burn+1):N], type = "l", xlab = "", ylab = "R")
abline(h = 1.2, lty = 2)

N <- 5000
burn <- 500
x0 <- c(-10, -5, 5, 10)
X <- matrix(nrow = 4, ncol = N)
for (i in 1:4)
{
  X[i,] <- rw_Metropolis(sigma[2], x0[i], N)$x
}
psi <- t(apply(X, 1, cumsum))
for (i in 1:nrow(psi))
  psi[i,] <- psi[i,] / (1:ncol(psi))
par(mfrow = c(2,2))
for (i in 1:4)
  plot(psi[i, (burn+1):N], type = "l", xlab = paste("x0 =", x0[i]), ylab = bquote(psi))
par(mfrow = c(1,1))
r_ <- numeric(N)
for (i in (burn+1):N)
  r_[i] <- GR(psi[,1:i])
plot(r_[(burn+1):N], type = "l", xlab = "", ylab = "R")
abline(h = 1.2, lty = 2)
index <- min(which(r_[r_ != 0] < 1.2))
rw <- rw_Metropolis(sigma[2], x0[2], index+burn)
plot(1:(index+burn), rw$x, type = "l", xlab = "", main = "Runs until converges")
```

In this section we just show the work with only one of the Chains we got in Exercise 9.4, since the steps are the same for different $\sigma$. We choose Chain 3 with $\sigma=0.5$, and the second plot above indicates that the Chain did not converge within 2000 iterations ($\hat R>1.2$). The fourth plot shows that the Chain converges within 5000 iterations, then run the Chain for 5000 iterations.

## Exercise 11.4
```{r}
k <- c(4:25, 100, 500, 1000)
roots <- numeric(length(k))
for (i in 1:length(k))
{
  f <- function(a) pt(sqrt(a^2*(k[i]-1)/(k[i]-a^2)), df = k[i]-1) - pt(sqrt(a^2*k[i]/(k[i]+1-a^2)), df = k[i])
  roots[i] <- uniroot(f, c(1e-10,sqrt(k[i])-1e-10))$root
}
print(roots)
plot(1:length(k), type = "l", roots, xlab = "", ylab = expression(A(k)), main = "Intersection points")
```